---
# OnTreeNode Allow Local Development Playbook
# This playbook stops the production ontreenode service on remote servers to allow local development.
# It ensures the service is stopped and port 3000 is available for development use.
# Usage: ansible-playbook -i inventory.ini ontreenode-allow-local-development-playbook.yaml

- name: Switch OnTreeNode to development mode on remote servers
  hosts: ontreenodes
  become: yes

  vars:
    app_name: "ontreenode"
    app_port: 3000

  tasks:
    - name: Check current status of {{ app_name }} service
      ansible.builtin.systemd:
        name: "{{ app_name }}"
      register: service_status
      failed_when: false

    - name: Display current service status
      ansible.builtin.debug:
        msg: "{{ app_name }} service is currently {{ service_status.status.ActiveState | default('not installed') }}"

    - name: Stop {{ app_name }} production service
      ansible.builtin.systemd:
        name: "{{ app_name }}"
        state: stopped
      when: service_status.status.ActiveState | default('inactive') == 'active'
      register: stop_result

    - name: Confirm service stopped
      ansible.builtin.debug:
        msg: "âœ“ Production service stopped successfully"
      when: stop_result is changed

    - name: Service was already stopped
      ansible.builtin.debug:
        msg: "â„¹ Production service was already stopped"
      when: stop_result is not changed and service_status.status.ActiveState | default('inactive') != 'active'

    - name: Verify service is actually stopped
      ansible.builtin.systemd:
        name: "{{ app_name }}"
      register: final_status
      failed_when: false

    - name: Ensure service is completely stopped
      ansible.builtin.assert:
        that:
          - final_status.status.ActiveState | default('inactive') != 'active'
        fail_msg: "ERROR: Service {{ app_name }} is still running after stop attempt"
        success_msg: "âœ“ Confirmed: {{ app_name }} service is not running"

    - name: Wait for port {{ app_port }} to become available
      ansible.builtin.wait_for:
        port: "{{ app_port }}"
        state: stopped
        timeout: 10
      register: port_check

    - name: Display development mode status
      ansible.builtin.debug:
        msg:
          - "ðŸš€ Development mode activated on remote server!"
          - "Port {{ app_port }} is now free on {{ inventory_hostname }}"
          - ""
          - "You can now deploy and test your changes on the remote server."
          - "When finished, run: ansible-playbook -i inventory.ini ontreenode-enable-production-playbook.yaml"
