---
- name: Install Caddy Web Server
  hosts: myhosts
  become: yes
  vars:
    caddy_user: caddy
    caddy_group: caddy
    caddy_config_dir: /etc/caddy
    caddy_config_file: /etc/caddy/Caddyfile

  tasks:
    - name: Install required dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - debian-keyring
          - debian-archive-keyring
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: Add Caddy official GPG key
      ansible.builtin.apt_key:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        state: present

    - name: Add Caddy repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        state: present
        filename: caddy-stable

    - name: Install Caddy
      ansible.builtin.apt:
        name: caddy
        state: present
        update_cache: yes

    - name: Ensure Caddy service is started and enabled
      ansible.builtin.systemd:
        name: caddy
        state: started
        enabled: yes

    - name: Create Caddyfile with admin API configuration
      ansible.builtin.copy:
        content: |
          {
              # Enable the admin API on localhost only. This is secure and sufficient.
              admin localhost:2019
          }
        dest: "{{ caddy_config_file }}"
        owner: "{{ caddy_user }}"
        group: "{{ caddy_group }}"
        mode: "0644"
      notify: restart caddy


    - name: Check if Caddy is running
      ansible.builtin.command: systemctl is-active caddy
      register: caddy_status
      changed_when: false
      failed_when: false

    - name: Display Caddy status
      ansible.builtin.debug:
        msg: "Caddy is {{ caddy_status.stdout }}"

    - name: Show installation completion message
      ansible.builtin.debug:
        msg: |
          Caddy has been installed successfully!
          - Service is running: {{ caddy_status.stdout == 'active' }}
          - Config file: {{ caddy_config_file }}
          - Admin API enabled on: localhost:2019

  handlers:
    - name: restart caddy
      ansible.builtin.systemd:
        name: caddy
        state: restarted
