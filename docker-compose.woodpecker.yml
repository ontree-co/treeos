version: '3'

services:
  woodpecker-server:
    image: woodpeckerci/woodpecker-server:latest
    restart: unless-stopped
    ports:
      - "8000:8000"  # HTTP port for the UI
      - "9000:9000"  # gRPC port for agents
    environment:
      # Server configuration
      - WOODPECKER_HOST=${WOODPECKER_HOST}  # e.g., https://ci.yourdomain.com
      - WOODPECKER_ADMIN=${WOODPECKER_ADMIN}  # Your Codeberg username
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}  # Shared secret for agents

      # Forge configuration (Codeberg/Forgejo)
      - WOODPECKER_FORGE=forgejo
      - WOODPECKER_FORGEJO_URL=https://codeberg.org
      - WOODPECKER_FORGEJO_CLIENT=${WOODPECKER_FORGEJO_CLIENT}  # OAuth Client ID
      - WOODPECKER_FORGEJO_SECRET=${WOODPECKER_FORGEJO_SECRET}  # OAuth Client Secret

      # Database configuration
      - WOODPECKER_DATABASE_DRIVER=sqlite3
      - WOODPECKER_DATABASE_DATASOURCE=/var/lib/woodpecker/woodpecker.db

      # Additional settings
      - WOODPECKER_LOG_LEVEL=info
      - WOODPECKER_OPEN=false  # Set to true to allow anyone to register
    volumes:
      - woodpecker-server-data:/var/lib/woodpecker
    networks:
      - woodpecker

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:latest
    restart: unless-stopped
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}  # Same as server
      - WOODPECKER_FILTER_LABELS=platform=linux/amd64,type=docker
      - WOODPECKER_MAX_WORKFLOWS=4
      - WOODPECKER_BACKEND=docker
      - WOODPECKER_BACKEND_DOCKER_VOLUMES=/tmp/woodpecker:/tmp/woodpecker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/woodpecker:/tmp/woodpecker
    depends_on:
      - woodpecker-server
    networks:
      - woodpecker

volumes:
  woodpecker-server-data:
    driver: local

networks:
  woodpecker:
    driver: bridge