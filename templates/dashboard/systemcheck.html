{{define "title"}}System Check - TreeOS{{end}}

{{define "content"}}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-7 col-xl-6">
        <div class="card card-border-soft text-body">
            <div class="card-body">
                <h2 class="card-title mb-3 text-success-emphasis">System Check</h2>

                {{template "system-check" .}}

                <form method="POST" action="/systemcheck" class="d-grid gap-3 mt-4 d-none" id="systemcheck-actions">
                    <button type="submit" name="action" value="complete" id="complete-setup-btn" class="btn btn-primary w-100" disabled>
                        <i class="bi bi-check-circle me-2"></i>Complete Setup
                    </button>
                    <div class="d-flex gap-3 flex-column flex-md-row d-none" id="secondary-actions">
                        <button type="submit" name="action" value="again" class="btn btn-outline-primary flex-fill">
                            <i class="bi bi-arrow-repeat me-2"></i>Run Again
                        </button>
                        <button type="submit" name="action" value="continue" class="btn btn-outline-secondary flex-fill">
                            Continue Without Fixing Everything
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Monitor system check results to enable/disable Complete Setup button
function monitorSystemCheckResults() {
    const completeBtn = document.getElementById('complete-setup-btn');
    const secondaryActions = document.getElementById('secondary-actions');
    const formActions = document.getElementById('systemcheck-actions');
    if (!completeBtn) return;

    // Function to check if all system checks are green
    function updateButtonState() {
        const systemCheckPanel = document.querySelector('[data-system-check]');
        if (!systemCheckPanel) return;

        const statusIcons = systemCheckPanel.querySelectorAll('.status-icon i');
        let allGreen = true;
        let hasResults = false;

        statusIcons.forEach(icon => {
            if (icon.classList.contains('bi-check-circle-fill') && icon.classList.contains('text-success')) {
                hasResults = true;
            } else if (icon.classList.contains('bi-x-circle-fill') && icon.classList.contains('text-danger')) {
                hasResults = true;
                allGreen = false;
            } else if (icon.classList.contains('bi-exclamation-triangle-fill') && icon.classList.contains('text-danger')) {
                hasResults = true;
                allGreen = false;
            }
        });

        // Show/hide buttons based on state
        const hasAnyResult = hasResults;
        formActions.classList.toggle('d-none', !hasAnyResult);
        secondaryActions.classList.toggle('d-none', !hasAnyResult || allGreen);

        if (hasResults && allGreen) {
            completeBtn.disabled = false;
            completeBtn.classList.remove('btn-outline-secondary');
            completeBtn.classList.add('btn-primary');
        } else {
            completeBtn.disabled = true;
            completeBtn.classList.remove('btn-primary');
            completeBtn.classList.add('btn-outline-secondary');
        }
    }

    // Monitor for changes in the system check panel
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
                updateButtonState();
            }
        });
    });

    const systemCheckPanel = document.querySelector('[data-system-check]');
    if (systemCheckPanel) {
        observer.observe(systemCheckPanel, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // Initial check
    setTimeout(updateButtonState, 1000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', monitorSystemCheckResults);
</script>
<style>
.system-check-panel,
.system-check-panel p,
.system-check-panel .fw-semibold,
.system-check-panel .status-icon i,
.system-check-panel strong,
.system-check-panel .text-body {
    color: var(--color-text-primary) !important;
}
</style>
{{end}}
