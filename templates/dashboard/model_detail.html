{{define "title"}}{{.Model.DisplayName}} - Model Details{{end}}

{{define "content"}}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{.Model.DisplayName}}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <!-- Model Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Model Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Name:</strong>
                        </div>
                        <div class="col-md-9">
                            {{.Model.DisplayName}}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Technical ID:</strong>
                        </div>
                        <div class="col-md-9">
                            <code>{{.Model.Name}}</code>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Category:</strong>
                        </div>
                        <div class="col-md-9">
                            <span class="badge bg-secondary">
                                {{if eq .Model.Category "chat"}}
                                    <i class="bi bi-chat-dots"></i> Chat
                                {{else if eq .Model.Category "code"}}
                                    <i class="bi bi-code-slash"></i> Code
                                {{else if eq .Model.Category "vision"}}
                                    <i class="bi bi-eye"></i> Vision
                                {{else}}
                                    {{.Model.Category}}
                                {{end}}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Size:</strong>
                        </div>
                        <div class="col-md-9">
                            {{.Model.SizeEstimate}}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Description:</strong>
                        </div>
                        <div class="col-md-9">
                            {{.Model.Description}}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Status:</strong>
                        </div>
                        <div class="col-md-9">
                            {{if eq .Model.Status "not_downloaded"}}
                                <span class="badge bg-secondary">Not Downloaded</span>
                            {{else if eq .Model.Status "queued"}}
                                <span class="badge bg-info">Queued</span>
                            {{else if eq .Model.Status "downloading"}}
                                <span class="badge bg-primary">Downloading ({{.Model.Progress}}%)</span>
                            {{else if eq .Model.Status "completed"}}
                                <span class="badge bg-success">Installed</span>
                            {{else if eq .Model.Status "failed"}}
                                <span class="badge bg-danger">Failed</span>
                            {{else}}
                                <span class="badge bg-secondary">{{.Model.Status}}</span>
                            {{end}}
                        </div>
                    </div>
                    {{if and .Model.LastError.Valid (eq .Model.Status "failed")}}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Error:</strong>
                        </div>
                        <div class="col-md-9">
                            <div class="alert alert-danger mb-0">
                                {{.Model.LastError.String}}
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Actions Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i> Actions
                    </h5>
                </div>
                <div class="card-body">
                    {{if .HasOllama}}
                        {{if eq .Model.Status "not_downloaded"}}
                            <button class="btn btn-primary w-100 mb-2" onclick="downloadModel('{{.Model.Name}}')">
                                <i class="bi bi-download"></i> Download Model
                            </button>
                        {{else if eq .Model.Status "queued"}}
                            <button class="btn btn-info w-100 mb-2" disabled>
                                <i class="bi bi-hourglass-split"></i> Queued for Download
                            </button>
                        {{else if eq .Model.Status "downloading"}}
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <button class="btn btn-danger" onclick="cancelDownload('{{.Model.Name}}');" title="Cancel Download">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                                <div class="progress flex-grow-1" style="height: 30px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar"
                                         style="width: {{.Model.Progress}}%"
                                         aria-valuenow="{{.Model.Progress}}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">{{.Model.Progress}}%</div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100 mb-2" disabled>
                                <i class="bi bi-arrow-repeat spin"></i> Downloading...
                            </button>
                        {{else if eq .Model.Status "completed"}}
                            {{if .IsInstalled}}
                                <button class="btn btn-success w-100 mb-2" disabled>
                                    <i class="bi bi-check-circle-fill"></i> Model Installed
                                </button>
                                <!-- Delete button only for installed models -->
                                <button class="btn btn-danger w-100"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModelModal">
                                    <i class="bi bi-trash"></i> Delete Model
                                </button>
                            {{else}}
                                <button class="btn btn-warning w-100 mb-2" onclick="downloadModel('{{.Model.Name}}')">
                                    <i class="bi bi-exclamation-triangle"></i> Model Missing - Re-download
                                </button>
                            {{end}}
                        {{else if eq .Model.Status "failed"}}
                            <button class="btn btn-warning w-100 mb-2" onclick="retryModel('{{.Model.Name}}')">
                                <i class="bi bi-arrow-clockwise"></i> Retry Download
                            </button>
                        {{end}}
                    {{else}}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> Ollama container is not running
                        </div>
                    {{end}}
                </div>
            </div>

            <!-- Usage Tips Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Usage Tips
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">To use this model with Ollama:</p>
                    <pre class="bg-light p-2 rounded"><code>ollama run {{.Model.Name}}</code></pre>
                    <p class="mb-0 text-muted small">
                        Run this command in a terminal with Docker access.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModelModal" tabindex="-1" aria-labelledby="deleteModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModelModalLabel">Delete Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the model <strong>{{.Model.DisplayName}}</strong>?</p>
                <p class="text-muted">This will remove the model from your system. You can re-download it later if needed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteModel('{{.Model.Name}}')">
                    <i class="bi bi-trash"></i> Delete Model
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function downloadModel(modelName) {
    fetch(`/api/models/${modelName}/pull`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard after starting download
            window.location.href = '/#models-container';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        console.error('Error downloading model:', error);
        alert('Failed to start download: ' + error.message);
    });
}

function retryModel(modelName) {
    fetch(`/api/models/${modelName}/retry`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard after retrying
            window.location.href = '/#models-container';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        console.error('Error retrying model:', error);
        alert('Failed to retry download: ' + error.message);
    });
}

function cancelDownload(modelName) {
    if (!confirm(`Cancel download of ${modelName}?`)) {
        return;
    }

    fetch(`/api/models/${modelName}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard after cancelling
            window.location.href = '/#models-container';
        } else {
            response.text().then(text => {
                alert('Failed to cancel download: ' + text);
            });
        }
    })
    .catch(error => {
        console.error('Error cancelling download:', error);
        alert('Failed to cancel download: ' + error.message);
    });
}

function deleteModel(modelName) {
    // Close the modal first
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModelModal'));
    modal.hide();

    // Show loading state
    const actionCard = document.querySelector('.card-body');
    if (actionCard) {
        actionCard.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Deleting...</span></div><p class="mt-2">Deleting model...</p></div>';
    }

    fetch(`/api/models/${modelName}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard after deletion
            window.location.href = '/#models-container';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        console.error('Error deleting model:', error);
        alert('Failed to delete model: ' + error.message);
        // Reload page on error to restore UI
        window.location.reload();
    });
}

// Add spinning animation CSS if not already present
if (!document.querySelector('#spin-style')) {
    const style = document.createElement('style');
    style.id = 'spin-style';
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    `;
    document.head.appendChild(style);
}
</script>
{{end}}