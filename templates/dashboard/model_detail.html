{{define "title"}}{{.Model.DisplayName}} - Model Details{{end}}

{{define "content"}}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/models">Models</a></li>
                <li class="breadcrumb-item active">{{.Model.DisplayName}}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {{if eq .Model.Category "chat"}}
                    <i class="bi bi-chat-dots"></i>
                {{else if eq .Model.Category "code"}}
                    <i class="bi bi-code-slash"></i>
                {{else if eq .Model.Category "vision"}}
                    <i class="bi bi-eye"></i>
                {{else}}
                    <i class="bi bi-cpu"></i>
                {{end}}
                {{.Model.DisplayName}}
            </h1>

            <a href="/models" class="btn btn-outline-secondary">
                ‚Üê Back to Models
            </a>
        </div>
    </div>
</div>

<!-- Model Information -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Model Information
                </h5>
                <div>
                    {{if .HasOllama}}
                        {{if eq .Model.Status "not_downloaded"}}
                            <button class="btn btn-primary" onclick="downloadModel('{{.Model.Name}}')">
                                <i class="bi bi-download"></i> Download Model
                            </button>
                        {{else if eq .Model.Status "queued"}}
                            <button class="btn btn-info" disabled>
                                <i class="bi bi-hourglass-split"></i> Queued for Download
                            </button>
                        {{else if eq .Model.Status "downloading"}}
                            <button class="btn btn-danger me-2" onclick="cancelDownload('{{.Model.Name}}');">
                                <i class="bi bi-x-lg"></i> Cancel Download
                            </button>
                            <button class="btn btn-primary" disabled>
                                <i class="bi bi-arrow-repeat spin"></i> Downloading ({{.Model.Progress}}%)
                            </button>
                        {{else if eq .Model.Status "completed"}}
                            {{if .IsInstalled}}
                                <button class="btn btn-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModelModal">
                                    <i class="bi bi-trash"></i> Delete Model
                                </button>
                            {{else}}
                                <button class="btn btn-warning" onclick="downloadModel('{{.Model.Name}}')">
                                    <i class="bi bi-exclamation-triangle"></i> Re-download
                                </button>
                            {{end}}
                        {{else if eq .Model.Status "failed"}}
                            <button class="btn btn-warning" onclick="retryModel('{{.Model.Name}}')">
                                <i class="bi bi-arrow-clockwise"></i> Retry Download
                            </button>
                        {{end}}
                    {{end}}
                </div>
            </div>
            <div class="card-body">
                {{if eq .Model.Status "downloading"}}
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: {{.Model.Progress}}%"
                         aria-valuenow="{{.Model.Progress}}"
                         aria-valuemin="0"
                         aria-valuemax="100">{{.Model.Progress}}%</div>
                </div>
                {{end}}

                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Name:</strong>
                    </div>
                    <div class="col-md-9">
                        {{.Model.DisplayName}}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Technical ID:</strong>
                    </div>
                    <div class="col-md-9">
                        <code>{{.Model.Name}}</code>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Category:</strong>
                    </div>
                    <div class="col-md-9">
                        <span class="badge bg-secondary">
                            {{if eq .Model.Category "chat"}}
                                <i class="bi bi-chat-dots"></i> Chat
                            {{else if eq .Model.Category "code"}}
                                <i class="bi bi-code-slash"></i> Code
                            {{else if eq .Model.Category "vision"}}
                                <i class="bi bi-eye"></i> Vision
                            {{else}}
                                {{.Model.Category}}
                            {{end}}
                        </span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Description:</strong>
                    </div>
                    <div class="col-md-9">
                        {{.Model.Description}}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Status:</strong>
                    </div>
                    <div class="col-md-9">
                        {{if eq .Model.Status "not_downloaded"}}
                            <span class="badge bg-secondary">Not Downloaded</span>
                        {{else if eq .Model.Status "queued"}}
                            <span class="badge bg-info">Queued</span>
                        {{else if eq .Model.Status "downloading"}}
                            <span class="badge bg-primary">Downloading</span>
                        {{else if eq .Model.Status "completed"}}
                            <span class="badge bg-success">Installed</span>
                        {{else if eq .Model.Status "failed"}}
                            <span class="badge bg-danger">Failed</span>
                        {{else}}
                            <span class="badge bg-secondary">{{.Model.Status}}</span>
                        {{end}}
                    </div>
                </div>
                {{if and .IsInstalled .RegistryPath}}
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Registry Location:</strong>
                    </div>
                    <div class="col-md-9">
                        <code class="d-block p-2 bg-light rounded">{{.RegistryPath}}</code>
                        <small class="text-muted mt-1 d-block">
                            <i class="bi bi-info-circle"></i> Model manifest file containing metadata and references
                        </small>
                    </div>
                </div>
                {{end}}
                {{if and .IsInstalled .BlobPath}}
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Blob Location:</strong>
                    </div>
                    <div class="col-md-9">
                        <code class="d-block p-2 bg-light rounded">{{.BlobPath}}</code>
                        <small class="text-muted mt-1 d-block">
                            <i class="bi bi-info-circle"></i> Actual model weights stored as content-addressed blob
                        </small>
                    </div>
                </div>
                {{end}}
                {{if .IsInstalled}}
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Blob Size:</strong>
                    </div>
                    <div class="col-md-9">
                        {{.Model.SizeEstimate}}
                    </div>
                </div>
                {{end}}
                {{if and .Model.LastError.Valid (eq .Model.Status "failed")}}
                <div class="row">
                    <div class="col-md-3">
                        <strong>Error:</strong>
                    </div>
                    <div class="col-md-9">
                        <div class="alert alert-danger mb-0">
                            {{.Model.LastError.String}}
                        </div>
                    </div>
                </div>
                {{end}}
                {{if not .HasOllama}}
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> Ollama container is not running. Please install an Ollama container to manage models.
                </div>
                {{end}}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModelModal" tabindex="-1" aria-labelledby="deleteModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModelModalLabel">Delete Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the model <strong>{{.Model.DisplayName}}</strong>?</p>
                <p class="text-muted">This will remove the model from your system. You can re-download it later if needed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteModel('{{.Model.Name}}')">
                    <i class="bi bi-trash"></i> Delete Model
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function downloadModel(modelName) {
    fetch(`/api/models/${modelName}/pull`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard/start page
            window.location.href = '/';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        console.error('Error downloading model:', error);
        alert('Failed to start download: ' + error.message);
    });
}

function retryModel(modelName) {
    fetch(`/api/models/${modelName}/retry`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard/start page
            window.location.href = '/';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        console.error('Error retrying model:', error);
        alert('Failed to retry download: ' + error.message);
    });
}

function cancelDownload(modelName) {
    if (!confirm(`Cancel download of ${modelName}?`)) {
        return;
    }

    fetch(`/api/models/${modelName}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            // Reload the page
            window.location.reload();
        } else {
            response.text().then(text => {
                alert('Failed to cancel download: ' + text);
            });
        }
    })
    .catch(error => {
        console.error('Error cancelling download:', error);
        alert('Failed to cancel download: ' + error.message);
    });
}

function deleteModel(modelName) {
    // Close the modal first
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModelModal'));
    modal.hide();

    fetch(`/api/models/${modelName}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            // Redirect to dashboard/start page
            window.location.href = '/';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    })
    .catch(error => {
        console.error('Error deleting model:', error);
        alert('Failed to delete model: ' + error.message);
    });
}

// Add spinning animation CSS if not already present
if (!document.querySelector('#spin-style')) {
    const style = document.createElement('style');
    style.id = 'spin-style';
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    `;
    document.head.appendChild(style);
}

// Set up SSE for real-time updates if model is downloading
{{if eq .Model.Status "downloading"}}
const eventSource = new EventSource('/api/models/events');
eventSource.onmessage = function(event) {
    // Reload the page to show updated status
    window.location.reload();
};

eventSource.onerror = function(error) {
    console.error('SSE error:', error);
};
{{end}}
</script>
{{end}}