{{define "base"}}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}{{.NodeName}} - TreeOS Node{{end}}</title>

    <!-- Prevent Flash of Unstyled Content (FOUC) -->
    <script>
        (function() {
            const theme = localStorage.getItem('treeos-theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/tokens.css">
    <link rel="stylesheet" href="/static/css/typography.css">
    <link rel="stylesheet" href="/static/css/buttons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">

    <link rel="icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    
    <style>
        /* IBM Plex Fonts - Self-hosted for better performance */
        @font-face {
            font-family: 'IBM Plex Sans';
            src: url('/static/fonts/IBMPlexSans-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'IBM Plex Mono';
            src: url('/static/fonts/IBMPlexMono-Italic.ttf') format('truetype');
            font-weight: 400;
            font-style: italic;
            font-display: swap;
        }
        
        /* Fallback for when fonts are loading */
        @supports not (font-display: swap) {
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            }
            .navbar-brand {
                font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            }
        }
        
        /* Global font application */
        body {
            font-family: var(--font-sans);
            font-weight: 400;
            line-height: 1.6;
        }

        /* Enhanced Header Styles */
        .main-header {
            background: var(--color-shell);
            border-bottom: 2px solid var(--color-border-subtle);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar-brand {
            font-family: var(--font-mono);
            font-style: italic;
            font-size: 1.6rem;
            font-weight: 400;
            color: var(--color-text-heading) !important;
            text-decoration: none !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            color: var(--color-text-primary) !important;
        }
        
        .brand-logo-img {
            width: 30px;
            height: 30px;
            object-fit: contain;
            margin-right: 4px;
        }

        .brand-logo-dark {
            display: none;
        }

        [data-theme="dark"] .brand-logo-light {
            display: none;
        }

        [data-theme="dark"] .brand-logo-dark {
            display: inline-block;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-action-btn {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0.25rem;
            border-radius: 999px;
            color: var(--color-text-muted);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none !important;
            text-decoration: none;
            cursor: pointer;
            line-height: 1;
        }

        .header-action-btn::after {
            display: none !important;
        }

        .header-action-btn:focus-visible {
            outline: 2px solid var(--color-brand-primary);
            outline-offset: 2px;
        }

        button.header-action-btn {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        .header-action-btn:hover,
        .header-action-btn:focus-visible,
        .header-action-btn:focus,
        .header-action-btn:active,
        .header-action-btn.show {
            color: var(--color-text-primary);
            background: transparent !important;
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        .header-action-btn svg {
            width: 22px;
            height: 22px;
        }

        .header-actions .header-action-btn,
        .header-actions .header-action-btn svg {
            background: transparent !important;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid var(--color-accent-blue-strong);
        }

        .settings-trigger {
            position: relative;
        }

        .settings-trigger svg {
            transition: none;
        }

        .update-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--color-feedback-error);
            border: 2px solid var(--color-background);
        }
        
        /* Dropdown menu styling */
        .dropdown-menu {
            background: var(--color-shell);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-md);
            box-shadow: var(--color-shadow-modal);
            padding: 0.5rem;
            margin-top: 1.75rem;
            min-width: 260px;
        }

        /* Ensure header dropdown clears the sticky header */
        .dropdown-menu[data-bs-popper] {
            margin-top: 1.75rem;
        }

        .dropdown-item {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #111827;
            text-decoration: none !important;
            background: transparent !important;
        }

        .dropdown-item:hover,
        .dropdown-item:focus,
        .dropdown-item:active,
        .dropdown-item.show {
            background: transparent !important;
            color: #111827;
            text-decoration: none !important;
        }

        .dropdown-divider {
            margin: 0.5rem 0;
            border-color: var(--color-border-subtle);
        }

        .dropdown-menu hr,
        .dropdown-menu .dropdown-divider {
            border-color: #eeeeee;
        }

        [data-theme="dark"] .dropdown-menu {
            background: var(--color-shell);
            border-color: var(--color-border-subtle);
            color: #e5e7eb;
        }

        [data-theme="dark"] .dropdown-menu .dropdown-item,
        [data-theme="dark"] .dropdown-menu .dropdown-item svg,
        [data-theme="dark"] .dropdown-menu .dropdown-header .fw-bold,
        [data-theme="dark"] .dropdown-menu .dropdown-header small,
        [data-theme="dark"] .dropdown-menu .dropdown-header div {
            color: #e5e7eb !important;
            stroke: #e5e7eb !important;
        }
        
        /* Theme Toggle Button Styles */
        .theme-toggle-btn {
            width: 40px;
            height: 40px;
            color: var(--color-text-muted);
            background: transparent !important;
        }

        /* Show/hide sun/moon icons based on theme */
        [data-theme="light"] .theme-icon--moon { display: none; }
        [data-theme="light"] .theme-icon--sun { display: block; }
        [data-theme="dark"] .theme-icon--moon { display: block; }
        [data-theme="dark"] .theme-icon--sun { display: none; }

        /* Mobile dropdown theme toggle */
        .dropdown-item[data-theme-toggle] {
            cursor: pointer;
            border: none;
            background: transparent !important;
            width: 100%;
            text-align: left;
        }

        .dropdown-item[data-theme-toggle]:hover {
            background-color: transparent !important;
            color: #111827;
        }

        .theme-toggle-label {
            margin-left: 0.25rem;
        }

        [data-theme="light"] .theme-toggle-label::after {
            content: "Dark mode";
        }

        [data-theme="dark"] .theme-toggle-label::after {
            content: "Light mode";
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.3rem;
            }
            .brand-icon {
                font-size: 1.5rem;
            }
            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
        }
        
        /* Funky gradient background for the main server status card */
        .funky-gradient-card {
            background: linear-gradient(135deg, var(--gradient-card-start-light) 0%, var(--gradient-card-end-light) 100%);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--gradient-card-border-light);
        }

        [data-theme="dark"] .funky-gradient-card {
            background: linear-gradient(135deg, var(--gradient-card-start-dark) 0%, var(--gradient-card-end-dark) 100%);
            border-color: var(--gradient-card-border-dark);
            color: var(--gray-5);
            text-shadow: none;
        }

        [data-theme="dark"] .funky-gradient-card .card-title {
            color: var(--gray-5);
        }
        
        /* Legacy styles for compatibility */
        .vital-card {
            transition: transform 0.2s;
        }
        .vital-card:hover {
            transform: translateY(-2px);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="app-shell">
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light main-header">
        <div class="container-xxl">
            <a class="navbar-brand" href="/">
                <img class="brand-logo-img brand-logo-light" src="/static/logo/logo.png" alt="TreeOS logo">
                <img class="brand-logo-img brand-logo-dark" src="/static/logo/logo-dark.png" alt="TreeOS logo">
                <span>TreeOS</span>
            </a>
            
            <div class="header-actions">
                <a
                    class="header-action-btn github-link d-none d-md-inline-flex"
                    href="https://github.com/ontree-co/treeos"
                    aria-label="View TreeOS on GitHub"
                    title="GitHub"
                    target="_blank"
                    rel="noreferrer"
                >
                    <svg class="icon icon-tabler icon-tabler-brand-github" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
                    </svg>
                </a>

                <!-- Theme Toggle - Desktop only -->
                <button
                    type="button"
                    class="header-action-btn theme-toggle-btn d-none d-md-flex"
                    data-theme-toggle
                    aria-label="Toggle theme"
                    title="Toggle light/dark mode"
                >
                    <svg class="theme-icon theme-icon--sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"></path>
                        <path d="M6.343 17.657l-1.414 1.414"></path>
                        <path d="M6.343 6.343l-1.414 -1.414"></path>
                        <path d="M17.657 6.343l1.414 -1.414"></path>
                        <path d="M17.657 17.657l1.414 1.414"></path>
                        <path d="M4 12h-2"></path>
                        <path d="M12 4v-2"></path>
                        <path d="M20 12h2"></path>
                        <path d="M12 20v2"></path>
                    </svg>
                    <svg class="theme-icon theme-icon--moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                    </svg>
                </button>

                {{if .User}}
                    <div class="dropdown">
                        <a class="header-action-btn settings-trigger" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <svg class="icon icon-tabler icon-tabler-settings" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.057c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.058 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.057 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.058c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.057c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.058 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.057 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.058z" />
                                <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                            </svg>
                            {{if .UpdateBadge}}
                            <span class="update-badge"></span>
                            {{end}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header d-flex align-items-center gap-2">
                                <div class="user-avatar">
                                    {{.UserInitial}}
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">{{.User.Username}}</div>
                                    <small class="text-dark">TreeOS</small>
                                    <div class="text-dark" style="font-size: 0.75rem;">
                                        Version: {{.Version}} ({{.VersionAge}})
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- Theme Toggle - Mobile only -->
                            <li class="d-md-none">
                                <button class="dropdown-item" data-theme-toggle>
                                    <span class="theme-icon theme-icon--sun">‚òÄÔ∏è</span>
                                    <span class="theme-icon theme-icon--moon">üåô</span>
                                    <span class="theme-toggle-label">Dark mode</span>
                                </button>
                            </li>
                            <li class="d-md-none"><hr class="dropdown-divider"></li>
                            {{if and .User .User.IsStaff .UpdateStatus.RestartRequired}}
                            <li><a class="dropdown-item text-danger" href="#" onclick="restartToApplyUpdate(event)">
                                <svg class="icon icon-tabler icon-tabler-refresh" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
                                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
                                </svg>
                                Restart to update{{if .UpdateStatus.AvailableVersion}} ({{.UpdateStatus.AvailableVersion}}){{end}}
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            {{end}}
                            <li><a class="dropdown-item" href="/settings">
                                <svg class="icon icon-tabler icon-tabler-settings" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.057c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.058 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.057 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.058c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.057c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.058 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.057 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.058z" />
                                    <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                                </svg>
                                Settings
                            </a></li>
                            <li><a class="dropdown-item" href="/logout">
                                <svg class="icon icon-tabler icon-tabler-logout" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                    <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                                    <path d="M7 12h14l-3 -3" />
                                    <path d="M18 15l3 -3" />
                                </svg>
                                Logout
                            </a></li>
                        </ul>
                    </div>
                {{end}}

                {{if not .User}}
                <!-- Theme toggle on mobile when logged out -->
                <button
                    type="button"
                    class="header-action-btn d-md-none"
                    data-theme-toggle
                    aria-label="Toggle theme"
                    title="Toggle light/dark mode"
                >
                    <svg class="theme-icon theme-icon--sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"></path>
                        <path d="M6.343 17.657l-1.414 1.414"></path>
                        <path d="M6.343 6.343l-1.414 -1.414"></path>
                        <path d="M17.657 6.343l1.414 -1.414"></path>
                        <path d="M17.657 17.657l1.414 1.414"></path>
                        <path d="M4 12h-2"></path>
                        <path d="M12 4v-2"></path>
                        <path d="M20 12h2"></path>
                        <path d="M12 20v2"></path>
                    </svg>
                    <svg class="theme-icon theme-icon--moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                    </svg>
                </button>
                {{end}}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container-xxl mt-4">
            {{if .Messages}}
                {{range .Messages}}
                    <div class="alert alert-{{.Type}} alert-dismissible fade show" role="alert">
                        {{.Text}}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {{end}}
            {{end}}

            {{block "content" .}}{{end}}
        </div>
    </main>

    <footer class="app-footer">
        <div class="container d-flex flex-column align-items-center text-center gap-2">
            <div class="footer-brand">
                <img class="footer-logo footer-logo-light" src="/static/logo/logo.png" alt="TreeOS logo">
                <img class="footer-logo footer-logo-dark" src="/static/logo/logo-dark.png" alt="TreeOS logo">
                <span class="footer-wordmark">TreeOS</span>
            </div>
            <p class="footer-meta">
                Built with ‚ù§Ô∏è in Europe
            </p>
        </div>
    </footer>

    <!-- Theme Toggle Script (load early) -->
    <script src="/static/js/theme-toggle.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- HTMX (local) -->
    <script src="/static/js/htmx-lite.js"></script>

    <!-- Configure HTMX to include CSRF token -->
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{.CSRFToken}}';
        });
    </script>

    <script>
        function restartToApplyUpdate(event) {
            event.preventDefault();
            if (!confirm('Restart now to finish installing the latest update?')) {
                return;
            }

            fetch('/api/system/update/restart', {
                method: 'POST'
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((data) => {
                            throw new Error(data.error || 'Failed to restart');
                        }).catch(() => {
                            throw new Error('Failed to restart');
                        });
                    }
                    return response.json();
                })
                .then((data) => {
                    alert((data && data.message) || 'Restarting to complete update...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                })
                .catch((error) => {
                    alert(error.message || 'Unable to restart at this time.');
                });
        }
    </script>

    <!-- PostHog Analytics -->
    {{if and .User .PostHogEnabled}}
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('{{.PostHogAPIKey}}', {
            api_host: '{{.PostHogHost}}',
            person_profiles: 'identified_only',
            loaded: function(posthog) {
                // Identify the user
                posthog.identify('{{.User.ID}}', {
                    is_staff: {{.User.IsStaff}},
                    is_superuser: {{.User.IsSuperuser}}
                });
            }
        });
    </script>
    {{end}}

    <!-- Unified Logging System -->
    <script>
    (function() {
        // Only enable browser logging if not in production or if explicitly enabled
        const isProduction = window.location.hostname !== 'localhost' && !window.location.hostname.startsWith('192.168');
        const loggingEnabled = !isProduction || localStorage.getItem('enableLogging') === 'true';

        if (!loggingEnabled) return;

        // Store original console functions
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info,
            debug: console.debug
        };

        // Function to send logs to server
        function sendLogToServer(level, args) {
            try {
                const message = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');

                // Skip empty messages or certain noisy messages
                if (!message || message.includes('DevTools') || message.includes('[HMR]')) {
                    return;
                }

                fetch('/api/log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{.CSRFToken}}'
                    },
                    body: JSON.stringify({
                        level: level,
                        source: 'browser',
                        message: message,
                        timestamp: new Date().toISOString(),
                        details: {
                            url: window.location.href,
                            userAgent: navigator.userAgent
                        }
                    })
                }).catch(err => {
                    // Silently fail to avoid infinite loop
                    originalConsole.error('Failed to send log:', err);
                });
            } catch (e) {
                // Silently fail
            }
        }

        // Override console methods
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            sendLogToServer('info', args);
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            sendLogToServer('error', args);
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            sendLogToServer('warn', args);
        };

        console.info = function(...args) {
            originalConsole.info.apply(console, args);
            sendLogToServer('info', args);
        };

        console.debug = function(...args) {
            originalConsole.debug.apply(console, args);
            if (localStorage.getItem('debug') === 'true') {
                sendLogToServer('debug', args);
            }
        };

        // Capture HTMX errors
        document.body.addEventListener('htmx:responseError', function(evt) {
            const errorInfo = {
                url: evt.detail.xhr.responseURL,
                status: evt.detail.xhr.status,
                statusText: evt.detail.xhr.statusText,
                responseText: evt.detail.xhr.responseText?.substring(0, 500)
            };
            console.error('HTMX Response Error:', errorInfo);
        });

        document.body.addEventListener('htmx:sendError', function(evt) {
            console.error('HTMX Send Error:', evt.detail);
        });

        document.body.addEventListener('htmx:timeout', function(evt) {
            console.error('HTMX Timeout:', evt.detail);
        });

        // Capture unhandled errors
        window.addEventListener('error', function(event) {
            console.error('Uncaught error:', {
                message: event.message,
                filename: event.filename,
                line: event.lineno,
                column: event.colno,
                error: event.error?.stack || event.error
            });
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Log initial page load
        console.info('Page loaded:', window.location.pathname);
    })();
    </script>

    {{block "extra_js" .}}{{end}}
</body>
</html>
{{end}}
