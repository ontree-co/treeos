name: Release macOS Binaries

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  build-macos:
    name: Build macOS Binaries
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: go.sum

      - name: Prepare embedded assets
        run: make embed-assets

      - name: Build for macOS ${{ matrix.arch }}
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}

          # Build with version info
          go build -ldflags "-s -w \
            -X github.com/stefanmunz/ontree-node/internal/version.Version=v${VERSION} \
            -X github.com/stefanmunz/ontree-node/internal/version.Commit=${GITHUB_SHA} \
            -X github.com/stefanmunz/ontree-node/internal/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o treeos-darwin-${{ matrix.arch }} \
            ./cmd/treeos

      - name: Create archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCHIVE_NAME="treeos_${VERSION}_darwin_${{ matrix.arch }}.tar.gz"

          # Create archive matching GoReleaser format
          tar -czf "${ARCHIVE_NAME}" treeos-darwin-${{ matrix.arch }}

          # Generate checksum
          shasum -a 256 "${ARCHIVE_NAME}" > "${ARCHIVE_NAME}.sha256"

          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Wait for Linux release
        run: |
          # Wait up to 10 minutes for the main release to be created
          for i in {1..40}; do
            if gh release view ${GITHUB_REF#refs/tags/} --repo ${{ github.repository }} &>/dev/null; then
              echo "Release found!"
              break
            fi
            echo "Waiting for release to be created... (attempt $i/40)"
            sleep 15
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release
        run: |
          # Upload macOS binary to the existing release
          gh release upload ${GITHUB_REF#refs/tags/} \
            "${ARCHIVE_NAME}" \
            "${ARCHIVE_NAME}.sha256" \
            --repo ${{ github.repository }} \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-public-release:
    name: Upload macOS to Public Repo
    needs: build-macos
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download macOS artifacts from release
        run: |
          mkdir -p macos-assets
          TAG=${GITHUB_REF#refs/tags/}

          # Download macOS binaries
          gh release download $TAG \
            --repo ${{ github.repository }} \
            --pattern "*darwin*.tar.gz*" \
            --dir macos-assets || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to public repository
        run: |
          TAG=${GITHUB_REF#refs/tags/}

          # Check if files were downloaded
          if ls macos-assets/*.tar.gz 1> /dev/null 2>&1; then
            echo "Uploading macOS binaries to public repository..."

            # Upload each macOS asset
            for file in macos-assets/*.tar.gz*; do
              gh release upload $TAG "$file" \
                --repo ontree-co/treeos \
                --clobber || true
            done
          else
            echo "No macOS binaries found to upload"
          fi
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASES_TOKEN }}